<!DOCTYPE html>
<html>
<head>
  <title>Tester de Socket.IO</title>
</head>
<body style="font-family: sans-serif;">
  <h1>Probador del Backend (V-FINAL - Ranking)</h1>
  <p>Abre la consola del navegador (F12) para ver los logs.</p>
  
  <fieldset>
    <legend>Paso 1: Autenticaci√≥n (API REST)</legend>
    Usuario: <input type="text" id="username" value="jugador_prueba_1">
    Correo: <input type="text" id="email" value="test1@test.com">
    Pass: <input type="text" id="password" value="123456">
    <br>
    <button id="btnRegistrar">Registrar Usuario</button>
    <button id="btnLogin">Iniciar Sesi√≥n (Login)</button>
  </fieldset>

  <fieldset>
    <legend>Paso 2: Conexi√≥n al Juego (Socket.IO)</legend>
    <p>Token guardado: <span id="tokenStatus" style="color: red;">(Ninguno)</span></p>
    <button id="btnConectarJuego">Conectar al Juego (con Token)</button>
  </fieldset>
  
  <fieldset>
    <legend>Paso 3: Probar el Juego (si est√°s conectado)</legend>
    <button id="testIniciar">Iniciar Nivel 1</button>
    <button id="testRespuesta">Enviar Respuesta (Correcta)</button>
    <button id="testBomba" style="background-color: #ffcccc;">üí£ Bomba</button>
    <button id="testCopo" style="background-color: #cceeff;">‚ùÑÔ∏è Copo</button>
  </fieldset>

  <fieldset>
    <legend>Paso 4: Probar API (Opcional)</legend>
    <button id="getDiaria">A. Obtener Pregunta Diaria</button>
    <button id="postDiaria">B. Enviar Respuesta Diaria</button>
  </fieldset>
  
  <fieldset>
    <legend>Paso 5: Ver Ranking Global</legend>
    <button id="btnRanking">Ver Ranking (Top 10)</button>
  </fieldset>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <script>
    // --- Constantes y Variables de Estado ---
    const ACIERTOS_PARA_GANAR = 5;
    let socket = null; 
    let authToken = null; 
    let preguntaActiva = null; 
    let preguntaDiariaActiva = null;
    let idJugadorPrueba = null; 
    const tokenStatus = document.getElementById('tokenStatus');

    // --- L√≥gica de Autenticaci√≥n (API REST) ---
    document.getElementById('btnRegistrar').addEventListener('click', async () => {
      const nombre_usuario = document.getElementById('username').value;
      const correo = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      console.log('API: Registrando usuario...');
      try {
        const response = await fetch('/api/jugadores/registro', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nombre_usuario, correo, password })
        });
        const resultado = await response.json();
        if (!response.ok) throw new Error(resultado.mensaje);
        console.log('%c¬°REGISTRO EXITOSO!', 'color: green;', resultado.mensaje);
      } catch (error) {
        console.error('Error al registrar:', error.message);
      }
    });

    document.getElementById('btnLogin').addEventListener('click', async () => {
      const nombre_usuario = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      console.log('API: Iniciando sesi√≥n...');
      try {
        const response = await fetch('/api/jugadores/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nombre_usuario, password })
        });
        const resultado = await response.json();
        if (!response.ok) throw new Error(resultado.mensaje);
        
        authToken = resultado.token; 
        const payload = JSON.parse(atob(authToken.split('.')[1]));
        idJugadorPrueba = payload.idJugador;
        
        console.log('%c¬°LOGIN EXITOSO!', 'color: green;', `Token guardado para ${payload.nombre}.`);
        tokenStatus.textContent = `(Token guardado para ${payload.nombre})`;
        tokenStatus.style.color = 'green';
        
      } catch (error) {
        console.error('Error al iniciar sesi√≥n:', error.message);
      }
    });
    
    // --- L√≥gica de Conexi√≥n al Juego (Socket.IO) ---
    document.getElementById('btnConectarJuego').addEventListener('click', () => {
      if (!authToken) {
        console.error('¬°No hay token! Inicia sesi√≥n primero.');
        return;
      }
      if (socket) {
        socket.disconnect(); // Desconectamos si ya hab√≠a uno
      }
      console.log('Conectando al servidor de juego (Socket.IO) con el token...');
      socket = io('http://localhost:3000', {
        auth: {
          token: authToken
        }
      });
      setupSocketListeners();
    });
    
    function setupSocketListeners() {
      socket.on('connect', () => {
        console.log('%c¬°CONECTADO AL JUEGO!', 'color: blue; font-weight: bold;', `ID: ${socket.id}`);
      });
      socket.on('connect_error', (err) => {
        console.error('Error de conexi√≥n:', err.message);
        alert('Error al conectar: ' + err.message);
      });

      socket.on('pregunta-nueva', (pregunta) => {
        console.log('%c¬°PREGUNTA RECIBIDA!', 'color: blue; font-weight: bold;', pregunta.enunciado_funcion);
        preguntaActiva = pregunta;
      });
      
      socket.on('estado-juego-actualizado', (estado) => {
        console.log('%c--- ESTADO ACTUALIZADO ---', 'color: purple;');
        if (estado.esCorrecta === true) console.log('%c¬°RESPUESTA CORRECTA!', 'color: green; font-weight: bold;');
        else if (estado.esCorrecta === false) console.log('%c¬°FALLO!', 'color: red; font-weight: bold;');
        
        console.log(`Vidas: ${estado.vidasRestantes} | Puntos: ${estado.puntuacionActual} | Aciertos: ${estado.aciertosActuales}/${ACIERTOS_PARA_GANAR}`);
        console.log(`Comodines: ${estado.comodines.bombas} Bombas, ${estado.comodines.copos} Copos`);
        console.log('%c--------------------------', 'color: purple;');
      });

      socket.on('juego-limpio', () => {
        console.log('%c¬°BOOM! üí£', 'font-size: 20px; color: orange;', 'El servidor limpi√≥ los zombis.');
        preguntaActiva = null; 
      });
      
      socket.on('juego-congelado', (datos) => {
        console.log('%c¬°CONGELADO! ‚ùÑÔ∏è', 'font-size: 20px; color: cyan;', `El juego se detendr√° por ${datos.duracionTicks} segundos.`);
      });

      socket.on('game-over', (resultado) => {
        console.error('¬°GAME OVER!', `Puntuaci√≥n final: ${resultado.puntuacionFinal}`);
        preguntaActiva = null;
      });

      socket.on('nivel-completado', (resultado) => {
        console.log('%c¬°NIVEL COMPLETADO!', 'color: purple; font-weight: bold;', `Puntuaci√≥n final: ${resultado.puntuacionFinal}`);
        preguntaActiva = null;
      });

      socket.on('error-juego', (error) => {
        console.error('Error del servidor:', error.mensaje);
      });

      socket.on('disconnect', () => {
        console.log('Desconectado del servidor de juego.');
      });
    }

    // --- OYENTES DE BOTONES (Juego Socket.IO) ---
    document.getElementById('testIniciar').addEventListener('click', () => {
      if (!socket) return console.warn('¬°Con√©ctate al juego primero!');
      console.log('Enviando evento "iniciar-nivel" con ID 1...');
      socket.emit('iniciar-nivel', 1); 
    });

    document.getElementById('testRespuesta').addEventListener('click', () => {
      if (!socket) return console.warn('¬°Con√©ctate al juego primero!');
      if (!preguntaActiva) {
        console.warn('¬°No hay pregunta activa!');
        return;
      }
      const miRespuesta = { idPregunta: preguntaActiva.id_pregunta, respuesta: preguntaActiva.respuesta_correcta }; 
      console.log(`Enviando respuesta CORRECTA para: ${preguntaActiva.enunciado_funcion}`);
      socket.emit('enviar-respuesta', miRespuesta);
      preguntaActiva = null;
    });
    
    document.getElementById('testBomba').addEventListener('click', () => {
      if (!socket) return console.warn('¬°Con√©ctate al juego primero!');
      console.log('Enviando evento "usar-comodin" - BOMBA');
      socket.emit('usar-comodin', { tipo: 'bomba' }); 
    });
    
    document.getElementById('testCopo').addEventListener('click', () => {
      if (!socket) return console.warn('¬°Con√©ctate al juego primero!');
      console.log('Enviando evento "usar-comodin" - COPO');
      socket.emit('usar-comodin', { tipo: 'copo' }); 
    });

    // --- OYENTES PARA BOTONES DE API (Pregunta Diaria) ---
    document.getElementById('getDiaria').addEventListener('click', async () => {
      console.log('API: Pidiendo pregunta diaria...');
      try {
        const response = await fetch('http://localhost:3000/api/preguntadiaria');
        if (!response.ok) throw new Error((await response.json()).mensaje);
        const pregunta = await response.json();
        preguntaDiariaActiva = pregunta;
        console.log('%c¬°PREGUNTA DIARIA RECIBIDA!', 'color: green; font-weight: bold;');
        console.log(`P: ${pregunta.enunciado_funcion}`);
        console.log(`R: ${pregunta.respuesta_correcta}`);
      } catch (error) {
        console.error('Error al obtener pregunta diaria:', error.message);
      }
    });

    document.getElementById('postDiaria').addEventListener('click', async () => {
      if (!preguntaDiariaActiva) return console.warn('Primero "Obtener Pregunta Diaria"');
      if (!idJugadorPrueba) return console.warn('Primero "Iniciar Sesi√≥n" para saber tu ID');
      
      const miRespuesta = {
        idPregunta: preguntaDiariaActiva.id_pregunta_diaria,
        respuesta: preguntaDiariaActiva.respuesta_correcta, 
        idJugador: idJugadorPrueba 
      };
      
      console.log('API: Enviando respuesta diaria...', miRespuesta);
      try {
        const response = await fetch('http://localhost:3000/api/preguntadiaria/responder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(miRespuesta),
        });
        const resultado = await response.json();
        if (!response.ok) throw new Error(resultado.mensaje);
        console.log('%c¬°RESPUESTA PROCESADA!', 'color: green; font-weight: bold;');
        console.log(resultado.mensaje);
      } catch (error) {
        console.error('Error al enviar respuesta diaria:', error.message);
      }
    });
    
    // --- ¬°NUEVO! OYENTE PARA BOT√ìN DE RANKING ---
    document.getElementById('btnRanking').addEventListener('click', async () => {
      console.log('API: Pidiendo el Ranking Global...');
      try {
        const response = await fetch('http://localhost:3000/api/ranking');
        if (!response.ok) throw new Error((await response.json()).mensaje);
        
        const ranking = await response.json();
        
        if (ranking.length === 0) {
          console.log('¬°El ranking est√° vac√≠o! Juega una partida para llenarlo.');
          return;
        }
        
        console.log('%c¬°RANKING GLOBAL (TOP 10)!', 'color: blue; font-weight: bold;');
        console.table(ranking); // Muestra una tabla bonita
        
      } catch (error) {
        console.error('Error al obtener el ranking:', error.message);
      }
    });
  </script>
</body>
</html>